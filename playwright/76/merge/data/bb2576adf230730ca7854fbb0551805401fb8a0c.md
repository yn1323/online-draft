# Test info

- Name: 参加者シナリオ >> 無効なコードで参加を試みる
- Location: /home/runner/work/online-draft/online-draft/e2e/tests/participant-journey.test.ts:95:7

# Error details

```
Error: locator.click: Test timeout of 30000ms exceeded.
Call log:
  - waiting for locator('button[type="submit"]:has-text("参加"), button:has-text("参加する")').first()
    - locator resolved to <button disabled type="button" aria-label="グループに参加する" class="chakra-button css-3lb50m">…</button>
  - attempting click action
    2 × waiting for element to be visible, enabled and stable
      - element is not enabled
    - retrying click action
    - waiting 20ms
    2 × waiting for element to be visible, enabled and stable
      - element is not enabled
    - retrying click action
      - waiting 100ms
    50 × waiting for element to be visible, enabled and stable
       - element is not enabled
     - retrying click action
       - waiting 500ms

    at /home/runner/work/online-draft/online-draft/e2e/tests/participant-journey.test.ts:107:26
    at /home/runner/work/online-draft/online-draft/e2e/tests/participant-journey.test.ts:98:5
```

# Page snapshot

```yaml
- button "テーマ設定を開く":
  - img
- heading "グループに参加" [level=1]
- paragraph: 参加コードやURLを入力してください
- group:
  - text: 参加コード
  - textbox "参加コードまたは招待リンク": "0000"
- button "グループに参加する" [disabled]:
  - paragraph: 参加する
- heading "最近参加したグループ" [level=2]
- button "今日のランチドラフトに参加する":
  - paragraph: 今日のランチドラフト
  - paragraph: 2時間前に参加
- button "映画選びドラフトに参加する":
  - paragraph: 映画選びドラフト
  - paragraph: 1日前に参加
- button "チームドラフトに参加する":
  - paragraph: チームドラフト
  - paragraph: 3日前に参加
- paragraph: 💡 主催者から参加コードか招待リンクをもらってください
- alert
- button "Open Next.js Dev Tools":
  - img
- button "Open issues overlay": 1 Issue
- button "Collapse issues badge":
  - img
```

# Test source

```ts
   7 | import { DraftOperations } from '../operations/draft-operations';
   8 | import { UserOperations } from '../operations/user-operations';
   9 | import { predefinedUsers, testUrls } from '../utils/test-data';
   10 | import { selectors } from '../utils/selectors';
   11 |
   12 | test.describe('参加者シナリオ', () => {
   13 |   let draftOps: DraftOperations;
   14 |   let userOps: UserOperations;
   15 |
   16 |   test.beforeEach(async ({ page }) => {
   17 |     draftOps = new DraftOperations(page);
   18 |     userOps = new UserOperations(page);
   19 |   });
   20 |
   21 |   test('4桁コードでドラフトに参加する', async ({ page, context }) => {
   22 |     let groupCode: string;
   23 |
   24 |     // 準備: 別タブで主催者がドラフトを作成
   25 |     await test.step('主催者がドラフトを準備', async () => {
   26 |       const organizerPage = await context.newPage();
   27 |       const organizerDraftOps = new DraftOperations(organizerPage);
   28 |       const organizerUserOps = new UserOperations(organizerPage);
   29 |       
   30 |       await organizerDraftOps.createNewDraft();
   31 |       await organizerUserOps.createNewUser(predefinedUsers.organizer);
   32 |       groupCode = await organizerDraftOps.getGroupCode();
   33 |       
   34 |       // 主催者ページは開いたままにしておく（リアルタイム同期の確認用）
   35 |     });
   36 |
   37 |     // Step 1: コードで参加
   38 |     await test.step('4桁コードで参加', async () => {
   39 |       await draftOps.joinWithCode(groupCode);
   40 |       
   41 |       // ロビーページに遷移したことを確認
   42 |       await expect(page).toHaveURL(/\/lobby\/[a-zA-Z0-9-]+/);
   43 |     });
   44 |
   45 |     // Step 2: グループ情報を確認
   46 |     await test.step('グループ情報を確認', async () => {
   47 |       await draftOps.verifyGroupInfo();
   48 |       
   49 |       // 主催者が既に参加していることを確認
   50 |       await userOps.verifyUserInParticipantList(predefinedUsers.organizer.name);
   51 |       await userOps.verifyParticipantCount(1);
   52 |     });
   53 |
   54 |     // Step 3: 参加者としてユーザーを作成
   55 |     await test.step('参加者ユーザーを作成', async () => {
   56 |       await userOps.createNewUser(predefinedUsers.participant1);
   57 |       
   58 |       // 参加者リストに自分が追加されたことを確認
   59 |       await userOps.verifyUserInParticipantList(predefinedUsers.participant1.name);
   60 |       await userOps.verifyParticipantCount(2);
   61 |     });
   62 |   });
   63 |
   64 |   test('URLでドラフトに参加する', async ({ page, context }) => {
   65 |     let groupId: string;
   66 |     let lobbyUrl: string;
   67 |
   68 |     // 準備: 主催者がドラフトを作成
   69 |     await test.step('主催者がドラフトを準備', async () => {
   70 |       const organizerPage = await context.newPage();
   71 |       const organizerDraftOps = new DraftOperations(organizerPage);
   72 |       const organizerUserOps = new UserOperations(organizerPage);
   73 |       
   74 |       await organizerDraftOps.createNewDraft();
   75 |       groupId = await organizerDraftOps.getCurrentGroupId();
   76 |       lobbyUrl = `${testUrls.base}/lobby/${groupId}`;
   77 |       await organizerUserOps.createNewUser(predefinedUsers.organizer);
   78 |     });
   79 |
   80 |     // Step 1: URLで参加
   81 |     await test.step('URLで参加', async () => {
   82 |       await draftOps.joinWithUrl(lobbyUrl);
   83 |       
   84 |       // ロビーページに遷移したことを確認
   85 |       await expect(page).toHaveURL(`/lobby/${groupId}`);
   86 |     });
   87 |
   88 |     // Step 2: 参加者として登録
   89 |     await test.step('参加者として登録', async () => {
   90 |       await userOps.createNewUser(predefinedUsers.participant2);
   91 |       await userOps.verifyParticipantCount(2);
   92 |     });
   93 |   });
   94 |
   95 |   test('無効なコードで参加を試みる', async ({ page }) => {
   96 |     const invalidCode = '0000'; // 存在しないコード
   97 |
   98 |     await test.step('無効なコードで参加を試みる', async () => {
   99 |       await page.goto(testUrls.join);
  100 |       
  101 |       // コード入力
  102 |       const codeInput = page.locator(selectors.join.codeInput).first();
  103 |       await codeInput.fill(invalidCode);
  104 |       
  105 |       // 参加ボタンをクリック
  106 |       const submitButton = page.locator(selectors.join.submitButton).first();
> 107 |       await submitButton.click();
      |                          ^ Error: locator.click: Test timeout of 30000ms exceeded.
  108 |       
  109 |       // エラーメッセージが表示されることを確認
  110 |       await draftOps.verifyErrorMessage('コードが無効です');
  111 |       
  112 |       // ページ遷移しないことを確認
  113 |       await expect(page).toHaveURL(testUrls.join);
  114 |     });
  115 |   });
  116 |
  117 |   test('履歴から再参加する', async ({ page, context }) => {
  118 |     let groupId: string;
  119 |     let groupCode: string;
  120 |
  121 |     // Step 1: 初回参加
  122 |     await test.step('初回参加してグループに入る', async () => {
  123 |       // 主催者がドラフトを作成
  124 |       const organizerPage = await context.newPage();
  125 |       const organizerDraftOps = new DraftOperations(organizerPage);
  126 |       const organizerUserOps = new UserOperations(organizerPage);
  127 |       
  128 |       await organizerDraftOps.createNewDraft();
  129 |       groupId = await organizerDraftOps.getCurrentGroupId();
  130 |       groupCode = await organizerDraftOps.getGroupCode();
  131 |       await organizerUserOps.createNewUser(predefinedUsers.organizer);
  132 |       
  133 |       // 参加者として参加
  134 |       await draftOps.joinWithCode(groupCode);
  135 |       await userOps.createNewUser(predefinedUsers.participant1);
  136 |     });
  137 |
  138 |     // Step 2: 一度離脱して履歴から再参加
  139 |     await test.step('履歴から再参加', async () => {
  140 |       // TOPページに戻る
  141 |       await page.goto(testUrls.top);
  142 |       
  143 |       // 参加ページに移動
  144 |       await page.goto(testUrls.join);
  145 |       
  146 |       // 履歴リストが表示されることを確認
  147 |       const recentList = page.locator(selectors.join.recentMeetingsList).first();
  148 |       await expect(recentList).toBeVisible();
  149 |       
  150 |       // 履歴から参加
  151 |       await draftOps.joinFromHistory(groupId);
  152 |       
  153 |       // ロビーページに遷移したことを確認
  154 |       await expect(page).toHaveURL(`/lobby/${groupId}`);
  155 |       
  156 |       // 既存ユーザーとして認識されることを確認
  157 |       const existingUserList = page.locator(selectors.lobby.userSelect.existingUserList).first();
  158 |       await expect(existingUserList).toBeVisible();
  159 |     });
  160 |   });
  161 |
  162 |   test('参加フォームのバリデーション', async ({ page }) => {
  163 |     await page.goto(testUrls.join);
  164 |
  165 |     await test.step('空のコードで参加を試みる', async () => {
  166 |       const submitButton = page.locator(selectors.join.submitButton).first();
  167 |       await submitButton.click();
  168 |       
  169 |       // バリデーションエラーが表示されることを確認
  170 |       const codeInput = page.locator(selectors.join.codeInput).first();
  171 |       await expect(codeInput).toHaveAttribute('aria-invalid', 'true');
  172 |     });
  173 |
  174 |     await test.step('不正な形式のコードを入力', async () => {
  175 |       const codeInput = page.locator(selectors.join.codeInput).first();
  176 |       
  177 |       // 3桁の数字
  178 |       await codeInput.fill('123');
  179 |       await expect(codeInput).toHaveAttribute('aria-invalid', 'true');
  180 |       
  181 |       // 文字を含む
  182 |       await codeInput.fill('12AB');
  183 |       await expect(codeInput).toHaveAttribute('aria-invalid', 'true');
  184 |       
  185 |       // 5桁の数字
  186 |       await codeInput.fill('12345');
  187 |       await expect(codeInput).toHaveAttribute('aria-invalid', 'true');
  188 |     });
  189 |
  190 |     await test.step('不正なURLを入力', async () => {
  191 |       const urlInput = page.locator(selectors.join.urlInput).first();
  192 |       
  193 |       // 不正なURL形式
  194 |       await urlInput.fill('not-a-url');
  195 |       const submitButton = page.locator(selectors.join.submitButton).first();
  196 |       await submitButton.click();
  197 |       
  198 |       await expect(urlInput).toHaveAttribute('aria-invalid', 'true');
  199 |     });
  200 |   });
  201 |
  202 |   test('複数の参加方法を切り替える', async ({ page }) => {
  203 |     await page.goto(testUrls.join);
  204 |
  205 |     await test.step('コード入力とURL入力を切り替える', async () => {
  206 |       const codeInput = page.locator(selectors.join.codeInput).first();
  207 |       const urlInput = page.locator(selectors.join.urlInput).first();
```

# Local changes

```diff
diff --git a/e2e/operations/draft-operations.ts b/e2e/operations/draft-operations.ts
new file mode 100644
index 0000000..8a9eba3
--- /dev/null
+++ b/e2e/operations/draft-operations.ts
@@ -0,0 +1,176 @@
+/**
+ * ドラフト作成・参加に関する操作をまとめたクラス
+ */
+
+import { type Page, expect } from '@playwright/test';
+import { selectors, getByText } from '../utils/selectors';
+import { timeouts, testUrls } from '../utils/test-data';
+
+export class DraftOperations {
+  constructor(private page: Page) {}
+
+  /**
+   * TOPページからドラフトを作成
+   */
+  async createNewDraft(): Promise<void> {
+    // TOPページに移動
+    await this.page.goto(testUrls.top);
+    
+    // ドラフト作成ボタンをクリック
+    const createButton = this.page.locator(selectors.top.createDraftButton).first();
+    await expect(createButton).toBeVisible();
+    await createButton.click();
+    
+    // ロビーページへの遷移を待つ
+    await this.page.waitForURL(/\/lobby\/[a-zA-Z0-9-]+/, {
+      timeout: timeouts.navigation,
+    });
+  }
+
+  /**
+   * 4桁コードでドラフトに参加
+   */
+  async joinWithCode(code: string): Promise<void> {
+    // 参加ページに移動
+    await this.page.goto(testUrls.join);
+    
+    // コード入力フィールドに入力
+    const codeInput = this.page.locator(selectors.join.codeInput).first();
+    await expect(codeInput).toBeVisible();
+    await codeInput.fill(code);
+    
+    // 参加ボタンをクリック
+    const submitButton = this.page.locator(selectors.join.submitButton).first();
+    await submitButton.click();
+    
+    // ロビーページへの遷移を待つ
+    await this.page.waitForURL(/\/lobby\/[a-zA-Z0-9-]+/, {
+      timeout: timeouts.navigation,
+    });
+  }
+
+  /**
+   * URLでドラフトに参加
+   */
+  async joinWithUrl(url: string): Promise<void> {
+    // 参加ページに移動
+    await this.page.goto(testUrls.join);
+    
+    // URL入力フィールドに入力
+    const urlInput = this.page.locator(selectors.join.urlInput).first();
+    await expect(urlInput).toBeVisible();
+    await urlInput.fill(url);
+    
+    // 参加ボタンをクリック
+    const submitButton = this.page.locator(selectors.join.submitButton).first();
+    await submitButton.click();
+    
+    // ロビーページへの遷移を待つ
+    await this.page.waitForURL(/\/lobby\/[a-zA-Z0-9-]+/, {
+      timeout: timeouts.navigation,
+    });
+  }
+
+  /**
+   * 履歴から参加
+   */
+  async joinFromHistory(groupId: string): Promise<void> {
+    // 参加ページに移動
+    await this.page.goto(testUrls.join);
+    
+    // 履歴リストが表示されるまで待つ
+    const recentList = this.page.locator(selectors.join.recentMeetingsList).first();
+    await expect(recentList).toBeVisible();
+    
+    // 特定のグループをクリック
+    // 履歴アイテムは実際のグループ名でクリック
+    const meetingItem = this.page.getByRole('button', { name: new RegExp(groupId) });
+    await expect(meetingItem).toBeVisible();
+    await meetingItem.click();
+    
+    // ロビーページへの遷移を待つ
+    await this.page.waitForURL(`/lobby/${groupId}`, {
+      timeout: timeouts.navigation,
+    });
+  }
+
+  /**
+   * 現在のグループIDを取得
+   */
+  async getCurrentGroupId(): Promise<string> {
+    const url = this.page.url();
+    const match = url.match(/\/lobby\/([a-zA-Z0-9-]+)/);
+    if (!match) {
+      throw new Error('グループIDが取得できません');
+    }
+    return match[1];
+  }
+
+  /**
+   * 現在のグループコードを取得（ロビーページから）
+   */
+  async getGroupCode(): Promise<string> {
+    // ロビーページにいることを確認
+    await expect(this.page).toHaveURL(/\/lobby\/[a-zA-Z0-9-]+/);
+    
+    // グループコードを表示している要素を探す
+    // 実際のコード表示部分を探す（例: "コード: 1234" のような表示）
+    const codeElement = this.page.locator('text=/コード.*\\d{4}/');
+    const code = await codeElement.textContent();
+    
+    if (!code) {
+      throw new Error('グループコードが取得できません');
+    }
+    
+    // 4桁の数字のみを抽出
+    const match = code.match(/\d{4}/);
+    if (!match) {
+      throw new Error('有効なグループコードが見つかりません');
+    }
+    
+    return match[0];
+  }
+
+  /**
+   * グループ情報が正しく表示されているか確認
+   */
+  async verifyGroupInfo(expectedTitle?: string): Promise<void> {
+    const titleElement = this.page.locator(selectors.lobby.groupInfo.title).first();
+    await expect(titleElement).toBeVisible();
+    
+    if (expectedTitle) {
+      await expect(titleElement).toContainText(expectedTitle);
+    }
+    
+    // 参加者リストが表示されているか確認
+    const participantList = this.page.locator(selectors.lobby.groupInfo.participantList).first();
+    await expect(participantList).toBeVisible();
+  }
+
+  /**
+   * エラーメッセージが表示されているか確認
+   */
+  async verifyErrorMessage(expectedMessage: string): Promise<void> {
+    // role="alert"またはaria-invalid="true"の要素を探す
+    const errorElement = this.page.locator('[role="alert"], [aria-invalid="true"]').first();
+    await expect(errorElement).toBeVisible();
+    await expect(errorElement).toContainText(expectedMessage);
+  }
+
+  /**
+   * ローディング状態が解消されるまで待つ
+   */
+  async waitForLoadingComplete(): Promise<void> {
+    // role="status"またはaria-busy="true"の要素を探す
+    const loading = this.page.locator('[role="status"], [aria-busy="true"]').first();
+    
+    // ローディングが表示されている場合は非表示になるまで待つ
+    try {
+      if (await loading.isVisible({ timeout: 1000 })) {
+        await expect(loading).toBeHidden({ timeout: timeouts.long });
+      }
+    } catch {
+      // ローディングが表示されていない場合は何もしない
+    }
+  }
+}
\ No newline at end of file
diff --git a/e2e/operations/user-operations.ts b/e2e/operations/user-operations.ts
new file mode 100644
index 0000000..63d1427
--- /dev/null
+++ b/e2e/operations/user-operations.ts
@@ -0,0 +1,158 @@
+/**
+ * ユーザー作成・選択に関する操作をまとめたクラス
+ */
+
+import { type Page, expect } from '@playwright/test';
+import { selectors } from '../utils/selectors';
+import { timeouts } from '../utils/test-data';
+import type { TestUser } from '../utils/test-data';
+
+export class UserOperations {
+  constructor(private page: Page) {}
+
+  /**
+   * 新規ユーザーを作成
+   */
+  async createNewUser(user: TestUser): Promise<void> {
+    // ロビーページにいることを確認
+    await expect(this.page).toHaveURL(/\/lobby\/[a-zA-Z0-9-]+/);
+    
+    // ユーザー選択ステップで「新規作成」ボタンをクリック
+    const createNewButton = this.page.locator(selectors.lobby.userSelect.createNewButton).first();
+    await expect(createNewButton).toBeVisible();
+    await createNewButton.click();
+    
+    // ユーザー作成ステップに遷移したことを確認
+    const createContainer = this.page.locator(selectors.lobby.userCreate.container).first();
+    await expect(createContainer).toBeVisible();
+    
+    // 名前を入力
+    const nameInput = this.page.locator(selectors.lobby.userCreate.nameInput).first();
+    await nameInput.fill(user.name);
+    
+    // アバターを選択
+    const avatarOption = this.page.getByRole('radio', { name: new RegExp(`アバター.*${user.avatarId}`) })
+      .or(this.page.locator(`img[alt*="${user.avatarId}"]`).first());
+    await avatarOption.click();
+    
+    // 確定ボタンをクリック
+    const confirmButton = this.page.locator(selectors.lobby.userCreate.confirmButton).first();
+    await confirmButton.click();
+    
+    // ドラフトページへの遷移を待つ（または次のステップへ）
+    await this.waitForUserCreationComplete();
+  }
+
+  /**
+   * 既存ユーザーを選択
+   */
+  async selectExistingUser(userId: string): Promise<void> {
+    // ロビーページにいることを確認
+    await expect(this.page).toHaveURL(/\/lobby\/[a-zA-Z0-9-]+/);
+    
+    // ユーザー選択ステップが表示されていることを確認
+    const selectContainer = this.page.locator(selectors.lobby.userSelect.container).first();
+    await expect(selectContainer).toBeVisible();
+    
+    // ユーザーリストから選択
+    const userItem = this.page.getByRole('button', { name: new RegExp(userId) })
+      .or(this.page.locator(selectors.lobby.userSelect.existingUserList).getByText(userId));
+    await expect(userItem).toBeVisible();
+    await userItem.click();
+    
+    // 選択完了を待つ
+    await this.waitForUserSelectionComplete();
+  }
+
+  /**
+   * 現在のステップを確認
+   */
+  async verifyCurrentStep(stepNumber: number): Promise<void> {
+    // ステップインジケーターの現在のステップを確認
+    const stepText = `ステップ${stepNumber}`;
+    const currentStep = this.page.locator('[aria-current="step"]')
+      .or(this.page.locator(`text=${stepText}`).filter({ hasText: /現在/ }));
+    await expect(currentStep).toBeVisible();
+  }
+
+  /**
+   * 参加者リストに特定のユーザーが表示されているか確認
+   */
+  async verifyUserInParticipantList(userName: string): Promise<void> {
+    const participantList = this.page.locator(selectors.lobby.groupInfo.participantList).first();
+    await expect(participantList).toBeVisible();
+    
+    // 参加者リスト内にユーザー名が含まれているか確認
+    await expect(participantList).toContainText(userName);
+  }
+
+  /**
+   * 参加者数を確認
+   */
+  async verifyParticipantCount(expectedCount: number): Promise<void> {
+    // 参加者数の表示を確認（例: "参加者: 3人"）
+    const countText = new RegExp(`参加者.*${expectedCount}`);
+    const countElement = this.page.getByText(countText);
+    await expect(countElement).toBeVisible();
+  }
+
+  /**
+   * アバター選択状態を確認
+   */
+  async verifyAvatarSelected(avatarId: number): Promise<void> {
+    // アバターの選択状態を確認
+    const avatarOption = this.page.getByRole('radio', { name: new RegExp(`アバター.*${avatarId}`), checked: true })
+      .or(this.page.locator(`[aria-checked="true"] img[alt*="${avatarId}"]`));
+    await expect(avatarOption).toBeVisible();
+  }
+
+  /**
+   * 名前入力のバリデーションエラーを確認
+   */
+  async verifyNameValidationError(errorMessage: string): Promise<void> {
+    // 名前入力フィールド周辺のエラーメッセージを確認
+    const errorElement = this.page.locator('[role="alert"]').filter({ hasText: errorMessage });
+    await expect(errorElement).toBeVisible();
+  }
+
+  /**
+   * ユーザー作成完了を待つ
+   */
+  private async waitForUserCreationComplete(): Promise<void> {
+    // ドラフトページへの遷移、または完了メッセージを待つ
+    await Promise.race([
+      this.page.waitForURL(/\/draft\/[a-zA-Z0-9-]+/, {
+        timeout: timeouts.navigation,
+      }),
+      // または次のステップへの遷移を待つ
+      this.page.locator(selectors.lobby.userSelect.container).waitFor({
+        state: 'hidden',
+        timeout: timeouts.medium,
+      }),
+    ]);
+  }
+
+  /**
+   * ユーザー選択完了を待つ
+   */
+  private async waitForUserSelectionComplete(): Promise<void> {
+    // ドラフトページへの遷移を待つ
+    await this.page.waitForURL(/\/draft\/[a-zA-Z0-9-]+/, {
+      timeout: timeouts.navigation,
+    });
+  }
+
+  /**
+   * 戻るボタンをクリック
+   */
+  async clickBackButton(): Promise<void> {
+    const backButton = this.page.getByText('戻る')
+      .or(this.page.getByRole('button', { name: /戻る/ }));
+    await expect(backButton).toBeVisible();
+    await backButton.click();
+    
+    // ユーザー選択ステップに戻ったことを確認
+    const selectContainer = this.page.locator(selectors.lobby.userSelect.container).first();
+    await expect(selectContainer).toBeVisible();
+  }
+}
\ No newline at end of file
diff --git a/e2e/setup/global-setup.ts b/e2e/setup/global-setup.ts
new file mode 100644
index 0000000..32b821e
--- /dev/null
+++ b/e2e/setup/global-setup.ts
@@ -0,0 +1,25 @@
+import { type FullConfig } from '@playwright/test';
+
+/**
+ * グローバルセットアップ
+ * E2Eテスト実行前の環境準備
+ */
+async function globalSetup(config: FullConfig) {
+  // 環境変数の設定
+  process.env.NODE_ENV = 'test';
+  
+  // Jotaiの複数インスタンス警告を抑制
+  process.env.JOTAI_SKIP_WARNING = 'true';
+  
+  console.log('🚀 E2Eテスト環境を準備しています...');
+  
+  // Firebase Emulatorの起動が必要な場合はここで実装
+  // await startFirebaseEmulator();
+  
+  return async () => {
+    console.log('🧹 E2Eテスト環境をクリーンアップしています...');
+    // クリーンアップ処理
+  };
+}
+
+export default globalSetup;
\ No newline at end of file
diff --git a/e2e/tests/organizer-journey.test.ts b/e2e/tests/organizer-journey.test.ts
new file mode 100644
index 0000000..a915c9b
--- /dev/null
+++ b/e2e/tests/organizer-journey.test.ts
@@ -0,0 +1,147 @@
+/**
+ * 主催者シナリオのE2Eテスト
+ * ユーザーストーリー: ドラフト会議を開催したい主催者がグループを作成し、参加者を待つ
+ */
+
+import { test, expect } from '@playwright/test';
+import { DraftOperations } from '../operations/draft-operations';
+import { UserOperations } from '../operations/user-operations';
+import { predefinedUsers, timeouts } from '../utils/test-data';
+import { selectors } from '../utils/selectors';
+
+test.describe('主催者シナリオ', () => {
+  let draftOps: DraftOperations;
+  let userOps: UserOperations;
+
+  test.beforeEach(async ({ page }) => {
+    draftOps = new DraftOperations(page);
+    userOps = new UserOperations(page);
+  });
+
+  test('新規ドラフトを作成し、主催者として参加する', async ({ page }) => {
+    // Step 1: TOPページからドラフトを作成
+    await test.step('ドラフトを作成', async () => {
+      await draftOps.createNewDraft();
+      
+      // ロビーページに遷移したことを確認
+      await expect(page).toHaveURL(/\/lobby\/[a-zA-Z0-9-]+/);
+    });
+
+    // Step 2: グループ情報を確認
+    const groupId = await test.step('グループ情報を確認', async () => {
+      await draftOps.verifyGroupInfo();
+      
+      // グループIDを取得（後で参加者に共有するため）
+      const id = await draftOps.getCurrentGroupId();
+      expect(id).toBeTruthy();
+      
+      return id;
+    });
+
+    // Step 3: 主催者としてユーザーを作成
+    await test.step('主催者ユーザーを作成', async () => {
+      await userOps.createNewUser(predefinedUsers.organizer);
+      
+      // 参加者リストに主催者が表示されることを確認
+      await userOps.verifyUserInParticipantList(predefinedUsers.organizer.name);
+      await userOps.verifyParticipantCount(1);
+    });
+
+    // Step 4: グループコードを確認（参加者に共有用）
+    const groupCode = await test.step('グループコードを取得', async () => {
+      const code = await draftOps.getGroupCode();
+      expect(code).toMatch(/^\d{4}$/); // 4桁の数字であることを確認
+      
+      console.log(`作成されたグループ: ID=${groupId}, Code=${code}`);
+      return code;
+    });
+
+    // Step 5: 参加者を待つ状態を確認
+    await test.step('参加者待機状態を確認', async () => {
+      // ドラフトページに遷移していることを確認（実装により異なる可能性）
+      // または、ロビーページで待機状態になっていることを確認
+      
+      // 参加者リストが更新可能な状態であることを確認
+      const participantList = page.locator(selectors.lobby.groupInfo.participantList).first();
+      await expect(participantList).toBeVisible();
+    });
+  });
+
+  test('作成したドラフトの設定を変更する', async ({ page }) => {
+    // Step 1: ドラフトを作成
+    await test.step('ドラフトを作成', async () => {
+      await draftOps.createNewDraft();
+    });
+
+    // Step 2: 主催者として参加
+    await test.step('主催者として参加', async () => {
+      await userOps.createNewUser(predefinedUsers.organizer);
+    });
+
+    // Step 3: 設定を変更（将来実装）
+    await test.step('ドラフト設定を変更', async () => {
+      // TODO: ドラフト設定変更機能が実装されたら追加
+      // - ドラフト名の変更
+      // - 参加人数制限の設定
+      // - ドラフト方式の選択
+      // - タイマー設定
+    });
+  });
+
+  test('既存ユーザーとして新規ドラフトを作成', async ({ page }) => {
+    // Step 1: ドラフトを作成
+    await test.step('ドラフトを作成', async () => {
+      await draftOps.createNewDraft();
+    });
+
+    // Step 2: 既存ユーザーが表示される場合は選択
+    await test.step('既存ユーザーを選択または新規作成', async () => {
+      // ユーザー選択画面が表示されることを確認
+      const userSelectContainer = page.locator(selectors.lobby.userSelect.container).first();
+      await expect(userSelectContainer).toBeVisible();
+      
+      // 既存ユーザーリストを確認
+      const existingUserList = page.locator(selectors.lobby.userSelect.existingUserList).first();
+      
+      // 既存ユーザーがいる場合は選択、いない場合は新規作成
+      if (await existingUserList.isVisible()) {
+        // TODO: 既存ユーザーの選択ロジック
+        // 現時点では新規作成を行う
+        await userOps.createNewUser(predefinedUsers.organizer);
+      } else {
+        await userOps.createNewUser(predefinedUsers.organizer);
+      }
+    });
+  });
+
+  test('ドラフト作成後、参加者の入室を確認', async ({ page, context }) => {
+    let groupCode: string;
+
+    // Step 1: 主催者がドラフトを作成
+    await test.step('主催者がドラフトを作成', async () => {
+      await draftOps.createNewDraft();
+      await userOps.createNewUser(predefinedUsers.organizer);
+      
+      // グループコードを取得
+      groupCode = await draftOps.getGroupCode();
+    });
+
+    // Step 2: 別タブで参加者が入室（リアルタイム同期のテスト）
+    await test.step('参加者が別タブから入室', async () => {
+      // 新しいタブを開く
+      const participantPage = await context.newPage();
+      const participantDraftOps = new DraftOperations(participantPage);
+      const participantUserOps = new UserOperations(participantPage);
+      
+      // 参加者がコードで参加
+      await participantDraftOps.joinWithCode(groupCode);
+      await participantUserOps.createNewUser(predefinedUsers.participant1);
+      
+      // 主催者側で参加者が表示されることを確認
+      await userOps.verifyUserInParticipantList(predefinedUsers.participant1.name);
+      await userOps.verifyParticipantCount(2);
+      
+      await participantPage.close();
+    });
+  });
+});
\ No newline at end of file
diff --git a/e2e/tests/participant-journey.test.ts b/e2e/tests/participant-journey.test.ts
new file mode 100644
index 0000000..197015e
--- /dev/null
+++ b/e2e/tests/participant-journey.test.ts
@@ -0,0 +1,219 @@
+/**
+ * 参加者シナリオのE2Eテスト
+ * ユーザーストーリー: ドラフト会議に参加したい人が、コード・URL・履歴から参加する
+ */
+
+import { test, expect } from '@playwright/test';
+import { DraftOperations } from '../operations/draft-operations';
+import { UserOperations } from '../operations/user-operations';
+import { predefinedUsers, testUrls } from '../utils/test-data';
+import { selectors } from '../utils/selectors';
+
+test.describe('参加者シナリオ', () => {
+  let draftOps: DraftOperations;
+  let userOps: UserOperations;
+
+  test.beforeEach(async ({ page }) => {
+    draftOps = new DraftOperations(page);
+    userOps = new UserOperations(page);
+  });
+
+  test('4桁コードでドラフトに参加する', async ({ page, context }) => {
+    let groupCode: string;
+
+    // 準備: 別タブで主催者がドラフトを作成
+    await test.step('主催者がドラフトを準備', async () => {
+      const organizerPage = await context.newPage();
+      const organizerDraftOps = new DraftOperations(organizerPage);
+      const organizerUserOps = new UserOperations(organizerPage);
+      
+      await organizerDraftOps.createNewDraft();
+      await organizerUserOps.createNewUser(predefinedUsers.organizer);
+      groupCode = await organizerDraftOps.getGroupCode();
+      
+      // 主催者ページは開いたままにしておく（リアルタイム同期の確認用）
+    });
+
+    // Step 1: コードで参加
+    await test.step('4桁コードで参加', async () => {
+      await draftOps.joinWithCode(groupCode);
+      
+      // ロビーページに遷移したことを確認
+      await expect(page).toHaveURL(/\/lobby\/[a-zA-Z0-9-]+/);
+    });
+
+    // Step 2: グループ情報を確認
+    await test.step('グループ情報を確認', async () => {
+      await draftOps.verifyGroupInfo();
+      
+      // 主催者が既に参加していることを確認
+      await userOps.verifyUserInParticipantList(predefinedUsers.organizer.name);
+      await userOps.verifyParticipantCount(1);
+    });
+
+    // Step 3: 参加者としてユーザーを作成
+    await test.step('参加者ユーザーを作成', async () => {
+      await userOps.createNewUser(predefinedUsers.participant1);
+      
+      // 参加者リストに自分が追加されたことを確認
+      await userOps.verifyUserInParticipantList(predefinedUsers.participant1.name);
+      await userOps.verifyParticipantCount(2);
+    });
+  });
+
+  test('URLでドラフトに参加する', async ({ page, context }) => {
+    let groupId: string;
+    let lobbyUrl: string;
+
+    // 準備: 主催者がドラフトを作成
+    await test.step('主催者がドラフトを準備', async () => {
+      const organizerPage = await context.newPage();
+      const organizerDraftOps = new DraftOperations(organizerPage);
+      const organizerUserOps = new UserOperations(organizerPage);
+      
+      await organizerDraftOps.createNewDraft();
+      groupId = await organizerDraftOps.getCurrentGroupId();
+      lobbyUrl = `${testUrls.base}/lobby/${groupId}`;
+      await organizerUserOps.createNewUser(predefinedUsers.organizer);
+    });
+
+    // Step 1: URLで参加
+    await test.step('URLで参加', async () => {
+      await draftOps.joinWithUrl(lobbyUrl);
+      
+      // ロビーページに遷移したことを確認
+      await expect(page).toHaveURL(`/lobby/${groupId}`);
+    });
+
+    // Step 2: 参加者として登録
+    await test.step('参加者として登録', async () => {
+      await userOps.createNewUser(predefinedUsers.participant2);
+      await userOps.verifyParticipantCount(2);
+    });
+  });
+
+  test('無効なコードで参加を試みる', async ({ page }) => {
+    const invalidCode = '0000'; // 存在しないコード
+
+    await test.step('無効なコードで参加を試みる', async () => {
+      await page.goto(testUrls.join);
+      
+      // コード入力
+      const codeInput = page.locator(selectors.join.codeInput).first();
+      await codeInput.fill(invalidCode);
+      
+      // 参加ボタンをクリック
+      const submitButton = page.locator(selectors.join.submitButton).first();
+      await submitButton.click();
+      
+      // エラーメッセージが表示されることを確認
+      await draftOps.verifyErrorMessage('コードが無効です');
+      
+      // ページ遷移しないことを確認
+      await expect(page).toHaveURL(testUrls.join);
+    });
+  });
+
+  test('履歴から再参加する', async ({ page, context }) => {
+    let groupId: string;
+    let groupCode: string;
+
+    // Step 1: 初回参加
+    await test.step('初回参加してグループに入る', async () => {
+      // 主催者がドラフトを作成
+      const organizerPage = await context.newPage();
+      const organizerDraftOps = new DraftOperations(organizerPage);
+      const organizerUserOps = new UserOperations(organizerPage);
+      
+      await organizerDraftOps.createNewDraft();
+      groupId = await organizerDraftOps.getCurrentGroupId();
+      groupCode = await organizerDraftOps.getGroupCode();
+      await organizerUserOps.createNewUser(predefinedUsers.organizer);
+      
+      // 参加者として参加
+      await draftOps.joinWithCode(groupCode);
+      await userOps.createNewUser(predefinedUsers.participant1);
+    });
+
+    // Step 2: 一度離脱して履歴から再参加
+    await test.step('履歴から再参加', async () => {
+      // TOPページに戻る
+      await page.goto(testUrls.top);
+      
+      // 参加ページに移動
+      await page.goto(testUrls.join);
+      
+      // 履歴リストが表示されることを確認
+      const recentList = page.locator(selectors.join.recentMeetingsList).first();
+      await expect(recentList).toBeVisible();
+      
+      // 履歴から参加
+      await draftOps.joinFromHistory(groupId);
+      
+      // ロビーページに遷移したことを確認
+      await expect(page).toHaveURL(`/lobby/${groupId}`);
+      
+      // 既存ユーザーとして認識されることを確認
+      const existingUserList = page.locator(selectors.lobby.userSelect.existingUserList).first();
+      await expect(existingUserList).toBeVisible();
+    });
+  });
+
+  test('参加フォームのバリデーション', async ({ page }) => {
+    await page.goto(testUrls.join);
+
+    await test.step('空のコードで参加を試みる', async () => {
+      const submitButton = page.locator(selectors.join.submitButton).first();
+      await submitButton.click();
+      
+      // バリデーションエラーが表示されることを確認
+      const codeInput = page.locator(selectors.join.codeInput).first();
+      await expect(codeInput).toHaveAttribute('aria-invalid', 'true');
+    });
+
+    await test.step('不正な形式のコードを入力', async () => {
+      const codeInput = page.locator(selectors.join.codeInput).first();
+      
+      // 3桁の数字
+      await codeInput.fill('123');
+      await expect(codeInput).toHaveAttribute('aria-invalid', 'true');
+      
+      // 文字を含む
+      await codeInput.fill('12AB');
+      await expect(codeInput).toHaveAttribute('aria-invalid', 'true');
+      
+      // 5桁の数字
+      await codeInput.fill('12345');
+      await expect(codeInput).toHaveAttribute('aria-invalid', 'true');
+    });
+
+    await test.step('不正なURLを入力', async () => {
+      const urlInput = page.locator(selectors.join.urlInput).first();
+      
+      // 不正なURL形式
+      await urlInput.fill('not-a-url');
+      const submitButton = page.locator(selectors.join.submitButton).first();
+      await submitButton.click();
+      
+      await expect(urlInput).toHaveAttribute('aria-invalid', 'true');
+    });
+  });
+
+  test('複数の参加方法を切り替える', async ({ page }) => {
+    await page.goto(testUrls.join);
+
+    await test.step('コード入力とURL入力を切り替える', async () => {
+      const codeInput = page.locator(selectors.join.codeInput).first();
+      const urlInput = page.locator(selectors.join.urlInput).first();
+      
+      // コードを入力
+      await codeInput.fill('1234');
+      
+      // URLフィールドに切り替えて入力
+      await urlInput.fill('https://example.com/lobby/test-id');
+      
+      // コードフィールドがクリアされることを確認（実装による）
+      // または両方入力できる場合は、どちらが優先され���か確認
+    });
+  });
+});
\ No newline at end of file
diff --git a/e2e/utils/selectors.ts b/e2e/utils/selectors.ts
new file mode 100644
index 0000000..74a6aa5
--- /dev/null
+++ b/e2e/utils/selectors.ts
@@ -0,0 +1,101 @@
+/**
+ * E2Eテスト用のアクセシブルなセレクター定義
+ * role属性、aria-label、テキストコンテンツを優先的に使用
+ */
+
+import { type Page } from '@playwright/test';
+
+// よく使うアクセシブルなセレクター
+export const selectors = {
+  // 共通要素
+  common: {
+    themeToggle: 'button[aria-label*="テーマ切替"], button[aria-label*="theme"]',
+    loading: '[role="status"], [aria-busy="true"]',
+    errorMessage: '[role="alert"], [aria-invalid="true"]',
+  },
+
+  // TOPページ
+  top: {
+    heroSection: 'main section:first-child',
+    createDraftButton: 'button:has-text("ドラフトを作成"), a:has-text("ドラフトを作成")',
+    joinDraftButton: 'button:has-text("ドラフトに参加"), a:has-text("ドラフトに参加")',
+    howToSection: 'section:has(h2:has-text("使い方"))',
+    // stepCardは個別に指定（一度しか使わないため）
+  },
+
+  // 参加ページ
+  join: {
+    joinForm: 'form[aria-label*="参加"], form:has(input[placeholder*="コード"])',
+    codeInput: 'input[placeholder*="コード"], input[aria-label*="コード"]',
+    urlInput: 'input[placeholder*="URL"], input[aria-label*="URL"]',
+    submitButton: 'button[type="submit"]:has-text("参加"), button:has-text("参加する")',
+    recentMeetingsList: 'ul[aria-label*="履歴"], div:has(h3:has-text("最近の参加"))',
+    joinHint: 'aside, [role="complementary"]',
+  },
+
+  // ロビーページ
+  lobby: {
+    container: 'main',
+    stepIndicator: 'nav[aria-label*="ステップ"], ol[role="list"]',
+    
+    // ユーザー選択ステップ
+    userSelect: {
+      container: 'section:has(h2:has-text("ユーザー選択"))',
+      existingUserList: 'ul[aria-label*="ユーザー一覧"], div:has(button[aria-label*="ユーザー"])',
+      createNewButton: 'button:has-text("新しいユーザーを作成")',
+    },
+    
+    // ユーザー作成ステップ
+    userCreate: {
+      container: 'section:has(h2:has-text("ユーザー作成"))',
+      nameInput: 'input[placeholder*="名前"], input[aria-label*="ユーザー名"]',
+      avatarSelector: '[role="radiogroup"], fieldset:has(legend:has-text("アバター"))',
+      confirmButton: 'button:has-text("確定"), button:has-text("作成")',
+      backButton: 'button:has-text("戻る"), button[aria-label*="戻る"]',
+    },
+    
+    // グループ情報
+    groupInfo: {
+      title: 'h1, h2:has-text("グループ")',
+      participantCount: 'span:has-text("参加者"), [aria-label*="参加者数"]',
+      participantList: 'ul[aria-label*="参加者"], div:has(h3:has-text("参加者"))',
+    },
+  },
+
+  // ドラフトページ（将来実装用）
+  draft: {
+    container: 'main',
+    chatArea: '[role="log"], section:has(h2:has-text("チャット"))',
+    chatInput: 'input[placeholder*="メッセージ"], textarea[aria-label*="チャット"]',
+    chatSendButton: 'button[aria-label*="送信"], button:has-text("送信")',
+    slotArea: 'section:has(h2:has-text("選択"))',
+    submitButton: 'button:has-text("確定"), button:has-text("提出")',
+  },
+
+  // モーダル・ダイアログ
+  modal: {
+    container: '[role="dialog"], [role="alertdialog"]',
+    closeButton: 'button[aria-label*="閉じる"], button:has-text("×")',
+    confirmButton: 'button:has-text("確認"), button:has-text("OK")',
+    cancelButton: 'button:has-text("キャンセル"), button:has-text("戻る")',
+  },
+} as const;
+
+/**
+ * アクセシブルなロケーター取得のヘルパー関数
+ */
+export const getByRole = (page: Page, role: string, options?: { name?: string | RegExp }) => {
+  return page.getByRole(role as any, options);
+};
+
+export const getByLabel = (page: Page, label: string | RegExp) => {
+  return page.getByLabel(label);
+};
+
+export const getByText = (page: Page, text: string | RegExp) => {
+  return page.getByText(text);
+};
+
+export const getByPlaceholder = (page: Page, placeholder: string | RegExp) => {
+  return page.getByPlaceholder(placeholder);
+};
\ No newline at end of file
diff --git a/e2e/utils/test-data.ts b/e2e/utils/test-data.ts
new file mode 100644
index 0000000..66d15a7
--- /dev/null
+++ b/e2e/utils/test-data.ts
@@ -0,0 +1,101 @@
+/**
+ * E2Eテスト用のテストデータ定義
+ */
+
+/**
+ * テスト用ユーザー情報
+ */
+export interface TestUser {
+  id: string;
+  name: string;
+  avatarId: number;
+}
+
+/**
+ * テスト用グループ情報
+ */
+export interface TestGroup {
+  id: string;
+  name: string;
+  code: string;
+  createdBy: string;
+}
+
+/**
+ * テスト用ユーザーを生成
+ */
+export function createTestUser(overrides?: Partial<TestUser>): TestUser {
+  const randomAvatarId = Math.floor(Math.random() * 18) + 1; // 1-18
+  return {
+    id: crypto.randomUUID(),
+    name: `テストユーザー_${Date.now()}`,
+    avatarId: randomAvatarId,
+    ...overrides,
+  };
+}
+
+/**
+ * テスト用グループを生成
+ */
+export function createTestGroup(overrides?: Partial<TestGroup>): TestGroup {
+  const id = overrides?.id || crypto.randomUUID();
+  return {
+    id,
+    name: `テストドラフト_${Date.now()}`,
+    code: generateTestCode(),
+    createdBy: 'test-user',
+    ...overrides,
+  };
+}
+
+/**
+ * テスト用の4桁コードを生成
+ */
+export function generateTestCode(): string {
+  return Math.floor(1000 + Math.random() * 9000).toString();
+}
+
+/**
+ * 事前定義されたテストユーザー
+ */
+export const predefinedUsers = {
+  organizer: createTestUser({
+    name: '主催者テスト',
+    avatarId: 1,
+  }),
+  participant1: createTestUser({
+    name: '参加者1',
+    avatarId: 2,
+  }),
+  participant2: createTestUser({
+    name: '参加者2',
+    avatarId: 3,
+  }),
+  latecomer: createTestUser({
+    name: '途中参加者',
+    avatarId: 4,
+  }),
+};
+
+/**
+ * タイムアウト設定（ミリ秒）
+ */
+export const timeouts = {
+  short: 1000,
+  medium: 3000,
+  long: 5000,
+  extraLong: 10000,
+  navigation: 5000,
+  animation: 500,
+};
+
+/**
+ * テスト環境のURL
+ */
+export const testUrls = {
+  base: process.env.PLAYWRIGHT_BASE_URL || 'http://localhost:3000',
+  top: '/',
+  join: '/join',
+  lobby: (id: string) => `/lobby/${id}`,
+  draft: (id: string) => `/draft/${id}`,
+};
\ No newline at end of file
diff --git a/package.json b/package.json
index 024abc8..1ebe90c 100644
--- a/package.json
+++ b/package.json
@@ -25,7 +25,7 @@
   "dependencies": {
     "@chakra-ui/react": "^3.19.2",
     "@emotion/react": "^11.14.0",
-    "@hookform/resolvers": "5.0.1",
+    "@hookform/resolvers": "5.1.0",
     "@storybook/addon-themes": "8.6.14",
     "@tanstack/react-form": "1.12.2",
     "firebase": "^11.8.1",
diff --git a/playwright.config.ts b/playwright.config.ts
index cab2d10..8f30fed 100644
--- a/playwright.config.ts
+++ b/playwright.config.ts
@@ -8,6 +8,8 @@ dotenv.config();
  */
 export default defineConfig({
   testDir: './e2e',
+  /* グローバルセットアップ */
+  globalSetup: require.resolve('./e2e/setup/global-setup'),
   /* Run tests in files in parallel */
   fullyParallel: true,
   /* Fail the build on CI if you accidentally left test.only in the source code. */
diff --git a/pnpm-lock.yaml b/pnpm-lock.yaml
index 9074783..515decd 100644
--- a/pnpm-lock.yaml
+++ b/pnpm-lock.yaml
@@ -15,8 +15,8 @@ importers:
         specifier: ^11.14.0
         version: 11.14.0(@types/react@19.1.6)(react@19.0.0)
       '@hookform/resolvers':
-        specifier: 5.0.1
-        version: 5.0.1(react-hook-form@7.57.0(react@19.0.0))
+        specifier: 5.1.0
+        version: 5.1.0(react-hook-form@7.57.0(react@19.0.0))
       '@storybook/addon-themes':
         specifier: 8.6.14
         version: 8.6.14(storybook@8.6.14)
@@ -878,8 +878,8 @@ packages:
   '@hapi/topo@5.1.0':
     resolution: {integrity: sha512-foQZKJig7Ob0BMAYBfcJk8d77QtOe7Wo4ox7ff1lQYoNNAb6jwcY1ncdoy2e9wQZzvNy7ODZCYJkK8kzmcAnAg==}
 
-  '@hookform/resolvers@5.0.1':
-    resolution: {integrity: sha512-u/+Jp83luQNx9AdyW2fIPGY6Y7NG68eN2ZW8FOJYL+M0i4s49+refdJdOp/A9n9HFQtQs3HIDHQvX3ZET2o7YA==}
+  '@hookform/resolvers@5.1.0':
+    resolution: {integrity: sha512-A5tY8gxqvvR0lFfropqpy/gUDOxjwT7LZCxJ8lNA9puK7nFNRl/O0egGKxzdF4JSz/pnnT1O8g76P/YMyTBEFw==}
     peerDependencies:
       react-hook-form: ^7.55.0
 
@@ -6141,7 +6141,7 @@ snapshots:
     dependencies:
       '@hapi/hoek': 9.3.0
 
-  '@hookform/resolvers@5.0.1(react-hook-form@7.57.0(react@19.0.0))':
+  '@hookform/resolvers@5.1.0(react-hook-form@7.57.0(react@19.0.0))':
     dependencies:
       '@standard-schema/utils': 0.3.0
       react-hook-form: 7.57.0(react@19.0.0)
```