name: CIçµæœé€šçŸ¥

on:
  workflow_run:
    workflows:
      - "build"
      - "lint"
      - "type-check"
      - "test"
      - "storybook-test"
      - "e2e"
    types:
      - completed
    # å…¨ãƒ–ãƒ©ãƒ³ãƒç›£è¦–ï¼ˆbranchesæŒ‡å®šãªã—

jobs:
  notify-ci-result:
    runs-on: ubuntu-latest
    # PRã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿å®Ÿè¡Œ
    if: >
      github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup

      - name: Check all workflow statuses
        id: check-workflows
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const headSha = context.payload.workflow_run.head_sha;
            
            // å¿…è¦ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å
            const requiredWorkflows = [
              'build',
              'lint', 
              'type-check',
              'test',
              'storybook-test',
              'e2e'
            ];
            
            console.log(`Checking workflows for commit: ${headSha}`);
            
            // è©²å½“ã‚³ãƒŸãƒƒãƒˆã®å…¨ãƒã‚§ãƒƒã‚¯å–å¾—
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: headSha,
              per_page: 100
            });
            
            console.log(`Found ${checkRuns.check_runs.length} check runs`);
            
            // ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡ŒçŠ¶æ³ã‚’ç¢ºèª
            const workflowStatuses = {};
            const completedWorkflows = [];
            
            for (const checkRun of checkRuns.check_runs) {
              const workflowName = checkRun.name;
              console.log(`Check: ${workflowName} - Status: ${checkRun.status} - Conclusion: ${checkRun.conclusion}`);
              
              // å¿…è¦ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ãƒã‚§ãƒƒã‚¯
              const matchedWorkflow = requiredWorkflows.find(required => 
                workflowName.includes(required)
              );
              
              if (matchedWorkflow && checkRun.status === 'completed') {
                workflowStatuses[matchedWorkflow] = checkRun.conclusion;
                completedWorkflows.push(matchedWorkflow);
              }
            }
            
            console.log('Workflow statuses:', workflowStatuses);
            console.log('Completed workflows:', completedWorkflows);
            
            // å…¨å¿…è¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Œäº†ã—ãŸã‹ç¢ºèª
            const allCompleted = requiredWorkflows.every(workflow => 
              completedWorkflows.includes(workflow)
            );
            
            console.log(`All workflows completed: ${allCompleted}`);
            
            if (allCompleted) {
              // ã™ã¹ã¦æˆåŠŸã—ãŸã‹ç¢ºèª
              const allSuccess = Object.values(workflowStatuses).every(conclusion => 
                conclusion === 'success' || conclusion === 'neutral'
              );
              
              console.log(`All workflows successful: ${allSuccess}`);
              
              // å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒªã‚¹ãƒˆ
              const failedWorkflows = Object.entries(workflowStatuses)
                .filter(([_, conclusion]) => conclusion === 'failure')
                .map(([name, _]) => name);
              
              core.setOutput('all_completed', 'true');
              core.setOutput('all_success', allSuccess.toString());
              core.setOutput('failed_workflows', failedWorkflows.join(', '));
              
              // PRã¾ãŸã¯ãƒ–ãƒ©ãƒ³ãƒæƒ…å ±
              const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
              const branchName = context.payload.workflow_run.head_branch;
              
              if (prNumber) {
                core.setOutput('pr_url', `https://github.com/${owner}/${repo}/pull/${prNumber}`);
                core.setOutput('context_info', `PR #${prNumber}`);
              } else {
                core.setOutput('branch_url', `https://github.com/${owner}/${repo}/tree/${branchName}`);
                core.setOutput('context_info', `Branch: ${branchName}`);
              }
            } else {
              core.setOutput('all_completed', 'false');
              const pendingWorkflows = requiredWorkflows.filter(workflow => 
                !completedWorkflows.includes(workflow)
              );
              console.log('Pending workflows:', pendingWorkflows);
            }

      - name: Notify Success
        if: steps.check-workflows.outputs.all_completed == 'true' && steps.check-workflows.outputs.all_success == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          tsx scripts/notify-slack.ts success \
            "CIå®Œäº† ğŸ‰" \
            "${{ steps.check-workflows.outputs.context_info }} - å…¨ãƒã‚§ãƒƒã‚¯é€šéï¼" \
            "GitHub Actions"

      - name: Notify Failure
        if: steps.check-workflows.outputs.all_completed == 'true' && steps.check-workflows.outputs.all_success != 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          tsx scripts/notify-slack.ts error \
            "CIå¤±æ•— âŒ" \
            "${{ steps.check-workflows.outputs.context_info }} - å¤±æ•—: ${{ steps.check-workflows.outputs.failed_workflows }}"