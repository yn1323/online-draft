name: VRT Deploy

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'PR number for deployment path'
        required: true
        type: string
      storybook_artifact:
        description: 'Storybook artifact name'
        required: true
        type: string
      report_artifact:
        description: 'VRT report artifact name'
        required: true
        type: string

jobs:
  deploy_to_github_pages:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    timeout-minutes: 30
    steps:
      - name: Checkout hosting-pages
        uses: actions/checkout@v6
        with:
          repository: yn1323/hosting-pages
          token: ${{ secrets.HOSTING_PAGES_TOKEN }}
          ref: main

      - name: Download Storybook artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.storybook_artifact }}
          path: "./online-draft/storybook/${{ inputs.pr_number }}"

      - name: Download VRT report artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.report_artifact }}
          path: "./online-draft/vrt/${{ inputs.pr_number }}"

      - name: Commit and push with retry
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add online-draft
          git commit -m "chore: Update VRT content for online-draft PR #${{ inputs.pr_number }}" || exit 0

          # „É™„Éà„É©„Ç§„É≠„Ç∏„ÉÉ„ÇØ - ÊúÄÂ§ß5Âõû„Åæ„ÅßË©¶Ë°å
          for i in {1..5}; do
            if git push; then
              echo "Successfully pushed on attempt $i"
              break
            else
              if [ $i -eq 5 ]; then
                echo "Failed to push after 5 attempts"
                exit 1
              fi
              echo "Push failed on attempt $i, retrying..."
              sleep 5
              git pull --rebase origin main
            fi
          done

      - name: Create PR comment with links
        uses: mshick/add-pr-comment@v2
        with:
          message-id: storybook-vrt
          message: |
            ü¶à Storybook VRT Report ü¶à
            [VRT Report](https://yn1323.github.io/hosting-pages/online-draft/vrt/${{ inputs.pr_number }})
            [Storybook](https://yn1323.github.io/hosting-pages/online-draft/storybook/${{ inputs.pr_number }})