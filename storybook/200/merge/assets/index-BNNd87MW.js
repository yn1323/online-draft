import{j as e}from"./stack-C7hvTRfV.js";import{I as z}from"./index-T8rPnJJ1.js";import{R as v}from"./responsive-modal-COX6Whib.js";import{u as H}from"./useChat-B9EMFcNf.js";import{d as q}from"./common-CDA3LAea.js";import{d as G,s as O}from"./index.esm2017-BvcukJ0n.js";import{r as V}from"./index-BXymfbzT.js";import{u as U,a as W,o as X,s as T}from"./schemas-CUQ-9AXQ.js";import{u as Y}from"./useModal-IzikcFvB.js";import{g as J,u as K,c as P,s as Q,b as Z}from"./states-Bd1A8IJM.js";import{V as x}from"./v-stack-3HiezQxF.js";import{B as ee}from"./box-DfzLPJuh.js";import{H as D}from"./h-stack-BRlU4uQg.js";import{T as l}from"./text-CD52-QEU.js";import{u as h}from"./react-BSHoCbAh.js";const te=()=>({upsertSelection:V.useCallback(async n=>{const{groupId:i,userId:o,item:a,comment:t,round:u,currentSelections:s}=n;try{const d=Math.floor(Math.random()*1e6),S=G(q,"app/onlinedraft/selection",o),y=s.filter(m=>m.userId===o).filter(m=>m.round!==u),I={item:a,comment:t,round:u,randomNumber:d},p=[...y.map(m=>({item:m.item,comment:m.comment,round:m.round,randomNumber:m.randomNumber})),I];return await O(S,{userId:o,selection:p}),i}catch(d){throw console.error("選択データのupsertに失敗しました:",d),d}},[])}),j=50,E=20,M=100,oe=(r,n,i,o)=>{if(!r||n===null||n===void 0)return{modalTitle:"ドラフト指名",defaultItem:"",defaultComment:"",isEditMode:!1,editContext:void 0};const a=o.find(s=>s.id===r),t=i.find(s=>s.userId===r&&s.round===n),u=!!t;return{modalTitle:u?"ドラフト指名を編集":"ドラフト指名",defaultItem:(t==null?void 0:t.item)||"",defaultComment:(t==null?void 0:t.comment)||"",isEditMode:u,editContext:u&&a?{round:n,playerName:a.name}:void 0}},re=(r,n,i,o)=>X({item:T().min(1,"アイテム名を入力してください").max(j,`${j}文字以内で入力してください`).refine(a=>r&&o&&a.toLowerCase()===o.toLowerCase()?!0:!n.filter(s=>s.round<i).some(s=>s.item.toLowerCase()===a.toLowerCase()),"このアイテムは過去のラウンドで既に選択されています"),comment:T().max(r?E:M,r?`${E}文字以内で入力してください`:`${M}文字以内で入力してください`).default("")}),L=Y,R=({isOpen:r,onClose:n,userId:i,round:o})=>{const a=V.useId(),t=h(Q),u=h(K),s=h(P),d=h(Z),{round:S}=h(J),C=u.find(({id:g})=>g===s),{sendSystemMessage:y}=H(),{modalTitle:I,defaultItem:p,defaultComment:F,isEditMode:m,editContext:c}=oe(i,o,t,u),{upsertSelection:$}=te(),{register:A,handleSubmit:B,formState:{errors:f,isSubmitting:b},reset:N}=U({resolver:W(re(m,t,S,p)),mode:"onChange",defaultValues:{item:p,comment:F}}),k=async g=>{try{if(await $({groupId:d,userId:i,item:g.item,comment:g.comment,round:o,currentSelections:t}),S!==o&&p!==g.item){const _=C==null?void 0:C.name;await y(d,`[${o}R-${c==null?void 0:c.playerName}] ${p}→${g.item} by ${_}`)}n(),N()}catch(_){console.error("指名エラー:",_)}},w=()=>{b||(n(),N())};return e.jsx(v,{isOpen:r,onClose:w,title:I,actions:{cancel:{text:"キャンセル",onClick:w},submit:{text:"決定",type:"submit",form:a,loading:b,disabled:b}},children:e.jsxs(x,{as:"form",id:a,onSubmit:B(k),gap:4,w:"full",children:[c&&e.jsx(ee,{w:"full",p:3,bg:"gray.50",borderRadius:"md",children:e.jsxs(x,{gap:2,align:"start",children:[e.jsxs(D,{children:[e.jsx(l,{fontSize:"xs",color:"gray.600",children:"ラウンド:"}),e.jsxs(l,{fontSize:"sm",fontWeight:"bold",children:["Round ",c.round]})]}),e.jsxs(D,{children:[e.jsx(l,{fontSize:"xs",color:"gray.600",children:"プレイヤー:"}),e.jsx(l,{fontSize:"sm",fontWeight:"bold",children:c.playerName})]})]})}),e.jsxs(x,{gap:2,align:"start",w:"full",children:[e.jsx(l,{fontSize:"sm",fontWeight:"bold",color:"gray.700",children:"ドラフト指名"}),e.jsx(z,{...A("item"),placeholder:"指名を入力してください",maxLength:j,size:"lg",error:!!f.item}),f.item&&e.jsx(l,{fontSize:"sm",color:"red.500",children:f.item.message})]}),e.jsxs(x,{gap:2,align:"start",w:"full",children:[e.jsx(l,{fontSize:"sm",fontWeight:"bold",color:"gray.700",children:"コメント（任意）"}),e.jsx(z,{...A("comment"),placeholder:c?"コメントを入力してください":"この指名についてのコメント...",maxLength:c?E:M,size:"lg",error:!!f.comment}),f.comment&&e.jsx(l,{fontSize:"sm",color:"red.500",children:f.comment.message})]})]})})};try{L.displayName="useItemSelectModal",L.__docgenInfo={description:`アイテム選択モーダル用hooks
汎用useModalを利用した軽量実装`,displayName:"useItemSelectModal",props:{}}}catch{}try{R.displayName="ItemSelectModal",R.__docgenInfo={description:`アイテム選択モーダルコンポーネント
react-hook-form + zodバリデーション使用`,displayName:"ItemSelectModal",props:{isOpen:{defaultValue:null,description:"",name:"isOpen",required:!0,type:{name:"boolean"}},onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}},userId:{defaultValue:null,description:"",name:"userId",required:!0,type:{name:"string"}},round:{defaultValue:null,description:"",name:"round",required:!0,type:{name:"number"}}}}}catch{}export{R as I,L as u};
