import{j as e}from"./stack-C7hvTRfV.js";import{I as T}from"./index-T8rPnJJ1.js";import{R as k}from"./responsive-modal-COX6Whib.js";import{u as H}from"./useChat-U4A5pV3T.js";import{d as q}from"./common-Be1Nl7Wn.js";import{d as G,s as O,b as U}from"./index.esm-sDRqfWCZ.js";import{r as V}from"./index-BXymfbzT.js";import{u as W,a as X,o as Y,s as z}from"./schemas-CUQ-9AXQ.js";import{u as J}from"./useModal-IzikcFvB.js";import{g as K,u as P,c as Q,s as Z,b as ee}from"./states-Bd1A8IJM.js";import{V as x}from"./v-stack-3HiezQxF.js";import{B as te}from"./box-DfzLPJuh.js";import{H as D}from"./h-stack-BRlU4uQg.js";import{T as l}from"./text-CD52-QEU.js";import{u as h}from"./react-BSHoCbAh.js";const oe=()=>({upsertSelection:V.useCallback(async n=>{const{groupId:i,userId:o,item:a,comment:t,round:u,currentSelections:s}=n;try{const d=Math.floor(Math.random()*1e6),S=G(q,"app/onlinedraft/selection",o),y=s.filter(m=>m.userId===o).filter(m=>m.round!==u),b={item:a,comment:t,round:u,randomNumber:d},p=[...y.map(m=>({item:m.item,comment:m.comment,round:m.round,randomNumber:m.randomNumber})),b],I={userId:o,selection:p,updatedAt:O()};return await U(S,I),i}catch(d){throw console.error("選択データのupsertに失敗しました:",d),d}},[])}),E=50,M=20,A=100,re=(r,n,i,o)=>{if(!r||n===null||n===void 0)return{modalTitle:"ドラフト指名",defaultItem:"",defaultComment:"",isEditMode:!1,editContext:void 0};const a=o.find(s=>s.id===r),t=i.find(s=>s.userId===r&&s.round===n),u=!!t;return{modalTitle:u?"ドラフト指名を編集":"ドラフト指名",defaultItem:(t==null?void 0:t.item)||"",defaultComment:(t==null?void 0:t.comment)||"",isEditMode:u,editContext:u&&a?{round:n,playerName:a.name}:void 0}},se=(r,n,i,o)=>Y({item:z().min(1,"アイテム名を入力してください").max(E,`${E}文字以内で入力してください`).refine(a=>r&&o&&a.toLowerCase()===o.toLowerCase()?!0:!n.filter(s=>s.round<i).some(s=>s.item.toLowerCase()===a.toLowerCase()),"このアイテムは過去のラウンドで既に選択されています"),comment:z().max(r?M:A,r?`${M}文字以内で入力してください`:`${A}文字以内で入力してください`).default("")}),L=J,R=({isOpen:r,onClose:n,userId:i,round:o})=>{const a=V.useId(),t=h(Z),u=h(P),s=h(Q),d=h(ee),{round:S}=h(K),C=u.find(({id:g})=>g===s),{sendSystemMessage:y}=H(),{modalTitle:b,defaultItem:p,defaultComment:I,isEditMode:m,editContext:c}=re(i,o,t,u),{upsertSelection:$}=oe(),{register:F,handleSubmit:v,formState:{errors:f,isSubmitting:_},reset:N}=W({resolver:X(se(m,t,S,p)),mode:"onChange",defaultValues:{item:p,comment:I}}),B=async g=>{try{if(await $({groupId:d,userId:i,item:g.item,comment:g.comment,round:o,currentSelections:t}),S!==o&&p!==g.item){const j=C==null?void 0:C.name;await y(d,`[${o}R-${c==null?void 0:c.playerName}] ${p}→${g.item} by ${j}`)}n(),N()}catch(j){console.error("指名エラー:",j)}},w=()=>{_||(n(),N())};return e.jsx(k,{isOpen:r,onClose:w,title:b,actions:{cancel:{text:"キャンセル",onClick:w},submit:{text:"決定",type:"submit",form:a,loading:_,disabled:_}},children:e.jsxs(x,{as:"form",id:a,onSubmit:v(B),gap:4,w:"full",children:[c&&e.jsx(te,{w:"full",p:3,bg:"gray.50",borderRadius:"md",children:e.jsxs(x,{gap:2,align:"start",children:[e.jsxs(D,{children:[e.jsx(l,{fontSize:"xs",color:"gray.600",children:"ラウンド:"}),e.jsxs(l,{fontSize:"sm",fontWeight:"bold",children:["Round ",c.round]})]}),e.jsxs(D,{children:[e.jsx(l,{fontSize:"xs",color:"gray.600",children:"プレイヤー:"}),e.jsx(l,{fontSize:"sm",fontWeight:"bold",children:c.playerName})]})]})}),e.jsxs(x,{gap:2,align:"start",w:"full",children:[e.jsx(l,{fontSize:"sm",fontWeight:"bold",color:"gray.700",children:"ドラフト指名"}),e.jsx(T,{...F("item"),placeholder:"指名を入力してください",maxLength:E,size:"lg",error:!!f.item}),f.item&&e.jsx(l,{fontSize:"sm",color:"red.500",children:f.item.message})]}),e.jsxs(x,{gap:2,align:"start",w:"full",children:[e.jsx(l,{fontSize:"sm",fontWeight:"bold",color:"gray.700",children:"コメント（任意）"}),e.jsx(T,{...F("comment"),placeholder:c?"コメントを入力してください":"この指名についてのコメント...",maxLength:c?M:A,size:"lg",error:!!f.comment}),f.comment&&e.jsx(l,{fontSize:"sm",color:"red.500",children:f.comment.message})]})]})})};try{L.displayName="useItemSelectModal",L.__docgenInfo={description:`アイテム選択モーダル用hooks
汎用useModalを利用した軽量実装`,displayName:"useItemSelectModal",props:{}}}catch{}try{R.displayName="ItemSelectModal",R.__docgenInfo={description:`アイテム選択モーダルコンポーネント
react-hook-form + zodバリデーション使用`,displayName:"ItemSelectModal",props:{isOpen:{defaultValue:null,description:"",name:"isOpen",required:!0,type:{name:"boolean"}},onClose:{defaultValue:null,description:"",name:"onClose",required:!0,type:{name:"() => void"}},userId:{defaultValue:null,description:"",name:"userId",required:!0,type:{name:"string"}},round:{defaultValue:null,description:"",name:"round",required:!0,type:{name:"number"}}}}}catch{}export{R as I,L as u};
