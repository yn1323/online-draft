import{c as W}from"./factory-DA62BenE.js";import{aD as X,h as Y,aE as Z,aF as q,aG as j,aH as h,au as w,an as H,aI as tt,aJ as et}from"./index-CXxrkVEp.js";import{r as s}from"./index-BXymfbzT.js";import{r as rt}from"./index-DGKHe-6Q.js";import{b as nt}from"./index-D_wZMSWw.js";import"./stack-BPGBxmP7.js";const[gt,vt]=W({name:"EnvironmentContext",hookName:"useEnvironmentContext",providerName:"<EnvironmentProvider />",strict:!1,defaultValue:{getRootNode:()=>document,getDocument:()=>document,getWindow:()=>window}}),[pt,Rt]=W({name:"LocaleContext",hookName:"useLocaleContext",providerName:"<LocaleProvider />",strict:!1,defaultValue:{dir:"ltr",locale:"en-US"}}),xt=()=>(t,u)=>u.reduce((c,f)=>{const[l,d]=c,S=f;return d[S]!==void 0&&(l[S]=d[S]),delete d[S],[l,d]},[{},{...t}]);var P=rt(),_=typeof globalThis.document<"u"?s.useLayoutEffect:s.useEffect;function T(t){const u=t().value??t().defaultValue,c=t().isEqual??Object.is,[f]=s.useState(u),[l,d]=s.useState(f),S=t().value!==void 0,E=s.useRef(l);E.current=S?t().value:l;const y=s.useRef(E.current);_(()=>{y.current=E.current},[l,t().value]);const C=p=>{var b,M;const i=y.current,g=w(p)?p(i):p;t().debug&&console.log(`[bindable > ${t().debug}] setValue`,{next:g,prev:i}),S||d(g),c(g,i)||(M=(b=t()).onChange)==null||M.call(b,g,i)};function V(){return S?t().value:l}return{initial:f,ref:E,get:V,set(p){(t().sync?P.flushSync:h)(()=>C(p))},invoke(p,i){var g,b;(b=(g=t()).onChange)==null||b.call(g,p,i)},hash(p){var i,g;return((g=(i=t()).hash)==null?void 0:g.call(i,p))??String(p)}}}T.cleanup=t=>{s.useEffect(()=>t,[])};T.ref=t=>{const u=s.useRef(t);return{get:()=>u.current,set:c=>{u.current=c}}};function ot(t){const u=s.useRef(t);return{get(c){return u.current[c]},set(c,f){u.current[c]=f}}}var ut=(t,u)=>{const c=s.useRef(!1),f=s.useRef(!1);s.useEffect(()=>{if(c.current&&f.current)return u();f.current=!0},[...(t??[]).map(l=>typeof l=="function"?l():l)]),s.useEffect(()=>(c.current=!0,()=>{c.current=!1}),[])};function mt(t,u={}){var $,A,B,G;const c=s.useMemo(()=>{const{id:r,ids:e,getRootNode:n}=u;return X({id:r,ids:e,getRootNode:n})},[u]),f=(...r)=>{t.debug&&console.log(...r)},l=(($=t.props)==null?void 0:$.call(t,{props:Y(u),scope:c}))??u,d=st(l),S=(A=t.context)==null?void 0:A.call(t,{prop:d,bindable:T,scope:c,flush:U,getContext(){return y},getComputed(){return z},getRefs(){return M}}),E=K(S),y={get(r){var e;return(e=E.current)==null?void 0:e[r].ref.current},set(r,e){var n;(n=E.current)==null||n[r].set(e)},initial(r){var e;return(e=E.current)==null?void 0:e[r].initial},hash(r){var n,o;const e=(n=E.current)==null?void 0:n[r].get();return(o=E.current)==null?void 0:o[r].hash(e)}},C=s.useRef(new Map),V=s.useRef(null),p=s.useRef(null),i=s.useRef({type:""}),g=()=>({...i.current,current(){return i.current},previous(){return p.current}}),b=()=>({...R,matches(...r){return r.includes(R.ref.current)},hasTag(r){var e,n;return!!((n=(e=t.states[R.ref.current])==null?void 0:e.tags)!=null&&n.includes(r))}}),M=ot(((B=t.refs)==null?void 0:B.call(t,{prop:d,context:y}))??{}),N=()=>({state:b(),context:y,event:g(),prop:d,send:O,action:L,guard:D,track:ut,refs:M,computed:z,flush:U,scope:c,choose:I}),L=r=>{const e=w(r)?r(N()):r;if(!e)return;const n=e.map(o=>{var v,m;const a=(m=(v=t.implementations)==null?void 0:v.actions)==null?void 0:m[o];return a||H(`[zag-js] No implementation found for action "${JSON.stringify(o)}"`),a});for(const o of n)o==null||o(N())},D=r=>{var e,n;return w(r)?r(N()):(n=(e=t.implementations)==null?void 0:e.guards)==null?void 0:n[r](N())},F=r=>{const e=w(r)?r(N()):r;if(!e)return;const n=e.map(a=>{var m,x;const v=(x=(m=t.implementations)==null?void 0:m.effects)==null?void 0:x[a];return v||H(`[zag-js] No implementation found for effect "${JSON.stringify(a)}"`),v}),o=[];for(const a of n){const v=a==null?void 0:a(N());v&&o.push(v)}return()=>o.forEach(a=>a==null?void 0:a())},I=r=>tt(r).find(e=>{let n=!e.guard;return et(e.guard)?n=!!D(e.guard):w(e.guard)&&(n=e.guard(N())),n}),z=r=>{Z(t.computed,()=>"[zag-js] No computed object found on machine");const e=t.computed[r];return e({context:y,event:g(),prop:d,refs:M,scope:c,computed:z})},R=T(()=>({defaultValue:t.initialState({prop:d}),onChange(r,e){var o,a,v,m;if(e){const x=C.current.get(e);x==null||x(),C.current.delete(e)}e&&L((o=t.states[e])==null?void 0:o.exit),L((a=V.current)==null?void 0:a.actions);const n=F((v=t.states[r])==null?void 0:v.effects);if(n&&C.current.set(r,n),e===j){L(t.entry);const x=F(t.effects);x&&C.current.set(j,x)}L((m=t.states[r])==null?void 0:m.entry)}})),J=s.useRef(void 0),k=s.useRef(q.NotStarted);_(()=>{queueMicrotask(()=>{const n=k.current===q.Started;k.current=q.Started,f(n?"rehydrating...":"initializing...");const o=J.current??R.initial;R.invoke(o,n?R.get():j)});const r=C.current,e=R.ref.current;return()=>{f("unmounting..."),J.current=e,k.current=q.Stopped,r.forEach(n=>n==null?void 0:n()),C.current=new Map,V.current=null,queueMicrotask(()=>{L(t.exit)})}},[]);const Q=()=>"ref"in R?R.ref.current:R.get(),O=r=>{queueMicrotask(()=>{var m,x;if(k.current!==q.Started)return;p.current=i.current,i.current=r,f("send",r);let e=Q();const n=((m=t.states[e].on)==null?void 0:m[r.type])??((x=t.on)==null?void 0:x[r.type]),o=I(n);if(!o)return;V.current=o;const a=o.target??e;f("transition",o);const v=a!==e;v?P.flushSync(()=>R.set(a)):o.reenter&&!v?R.invoke(e,e):L(o.actions??[])})};return(G=t.watch)==null||G.call(t,N()),{state:b(),send:O,context:y,prop:d,scope:c,refs:M,computed:z,event:g(),getStatus:()=>k.current}}function K(t){const u=s.useRef(t);return u.current=t,u}function st(t){const u=K(t);return function(f){return u.current[f]}}function U(t){queueMicrotask(()=>{P.flushSync(()=>t())})}var St=nt(t=>t);export{vt as a,mt as b,xt as c,St as n,P as r,Rt as u};
