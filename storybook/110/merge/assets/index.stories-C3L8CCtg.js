import{u as Re,a as ke,d as Ue,g as Ne,b as we,c as Ie,s as Ae,e as Me,f as Ee,h as Oe,i as ve,j as Pe,w as ze}from"./useRealtimeUsers-V8H5-64S.js";import{c as Te,j as e,f as _e}from"./create-recipe-context-LbQq3bM7.js";import{r as o}from"./index-BXymfbzT.js";import{u as ae,h as ie}from"./index-C1CVZOuA.js";import{C as R}from"./container-BXrbxM4E.js";import{V as p}from"./v-stack-DfIdlA7P.js";import{a as z,B as I}from"./button-Cvi4ewak.js";import{T as D}from"./text-BOFVnBsW.js";import{B as E}from"./box-p2MKwv57.js";import{U as He}from"./index-DlW_aOcq.js";import{C as Ve}from"./index-BiV_yDOu.js";import{D as We}from"./index-DYm13Dy0.js";import{T as Fe}from"./index-Di9UZVpw.js";import{I as qe}from"./index-AdId0A93.js";import{O as Ge}from"./index-bej-6NU3.js";import{R as Be}from"./index-sVZNNNiq.js";import{m as le,a as Le}from"./mocks-C8FdBju4.js";import{G as $e}from"./grid-DCXQ59mM.js";import{m as Je}from"./stack-B-mkjmc_.js";import"./jsx-runtime-Bw5QeaCk.js";import"./index-B7YJKKKT.js";import"./_interop_require_wildcard-BpaVepTj.js";import"./segment-DQKAVVpM.js";import"./responsive-modal-u4uUSmq6.js";import"./index-B2ItOoBf.js";import"./iconBase-BtwG8oUN.js";import"./icon-button-Bwmz2JOC.js";import"./portal-DXIUxZbP.js";import"./create-slot-recipe-context-9ZU4Gcb9.js";import"./factory-OeC611uy.js";import"./index-B1VjsNl3.js";import"./index-C85FKF7s.js";import"./index-DGKHe-6Q.js";import"./index-CrjboX4Z.js";import"./index-CEI8PRn9.js";import"./index-BRNWFSEf.js";import"./use-breakpoint-CtC0MXDZ.js";import"./h-stack-BOuMwgNM.js";import"./image-D2VQ_BCA.js";import"./input-C3XuNbVL.js";import"./use-field-context-BeRDi0mX.js";import"./textarea-CzEKuGQU.js";import"./index-KLwv-BE1.js";import"./flex-CZZAfvJj.js";import"./index-DzMPqw62.js";import"./toaster-Ccw28dmr.js";import"./index-CpN0Y-_B.js";import"./theme-BEsXwnFK.js";import"./index-B0tjTtPU.js";import"./index-B_WG8SGj.js";import"./index-DzZ9wzu-.js";import"./index-nasXlWCh.js";import"./index-BumpzSCx.js";function Y(t){return Je(t,n=>n==="auto"?"auto":`span ${n}/span ${n}`)}const Z=o.forwardRef(function(n,r){const{area:i,colSpan:l,colStart:d,colEnd:m,rowEnd:c,rowSpan:y,rowStart:f,...a}=n,k=Te({gridArea:i,gridColumn:Y(l),gridRow:Y(y),gridColumnStart:d,gridColumnEnd:m,gridRowStart:f,gridRowEnd:c});return e.jsx(_e.div,{ref:r,css:k,...a})}),ce=t=>{const{isAuthenticated:n,groupExists:r,loading:i,authError:l,groupError:d,retry:m}=Re(t),{sessionUser:c,loading:y,error:f,needsUserSelection:a,hasValidSession:k,selectUser:w,clearUser:U,retry:N}=ke(t),C=n&&r,b=!!l||!!d,h=i||C&&y,x=o.useMemo(()=>C&&k&&!!c,[C,k,c]),u=o.useMemo(()=>C&&a,[C,a]),O=o.useCallback(()=>{console.log("🔄 DraftAuth統合リトライ実行"),m(),N()},[m,N]),T=o.useCallback(()=>{console.log("🗑️ DraftAuthセッションクリア"),U()},[U]);return console.log("🔐 useDraftAuth state:",{groupId:t,firebaseAuthenticated:n,groupExists:r,sessionUser:c?{id:c.id,name:c.name}:null,isReady:x,needsUserSelection:u,hasAuthError:b,loading:h}),{isReady:x,needsUserSelection:u,hasAuthError:b,loading:h,authError:l||d,userError:f,currentUser:c,selectUser:w,retry:O,clearSession:T}},Ke=t=>({ABC123:[{id:"msg1",userId:"user1",userName:"田中太郎",message:"よろしくお願いします！",timestamp:new Date(Date.now()-3e5),type:"user"},{id:"msg2",userId:"system",userName:"システム",message:"Round 1 開始",timestamp:new Date(Date.now()-24e4),type:"system"},{id:"msg3",userId:"user2",userName:"山田花子",message:"こちらこそ！頑張りましょう",timestamp:new Date(Date.now()-18e4),type:"user"}]})[t]||[],Qe=(t,n=[])=>{const[r,i]=o.useState([]),[l,d]=o.useState(!0),[m,c]=o.useState(null);return o.useEffect(()=>{if(t){console.log("📚 Storybook環境のためモックチャットを使用");const y=Ke(t);i(y),d(!1);return}},[t,n]),{messages:r,loading:l,error:m}},Xe=()=>{const[t,n]=o.useState(!1),[r,i]=o.useState(null);return{sendMessage:async({groupId:d,userId:m,message:c})=>c.trim()?(console.log("📚 Storybook環境のためメッセージ送信をモック"),n(!0),await new Promise(y=>setTimeout(y,500)),n(!1),!0):(i("メッセージを入力してください"),!1),sending:t,error:r}},Ye=(t,n)=>{const r=t.filter(l=>l.currentRound===n);if(r.length===0)return!1;const i=r.every(l=>l.status==="completed");return console.log("🏁 ラウンド完了チェック:",{currentRound:n,participants:r.length,allCompleted:i}),i},Ze=(t,n)=>{const[r,i]=o.useState([]),[l,d]=o.useState(!0),[m,c]=o.useState(null),[y,f]=o.useState(!1),a=o.useCallback(()=>[{userId:"user1",groupId:t,userName:"田中太郎",avatar:"/img/1.png",deleteFlg:!1,status:"thinking",currentRound:n,createdAt:new Date,updatedAt:new Date},{userId:"user2",groupId:t,userName:"山田花子",avatar:"/img/2.png",deleteFlg:!1,status:"entered",currentRound:n,createdAt:new Date,updatedAt:new Date},{userId:"user3",groupId:t,userName:"佐藤次郎",avatar:"/img/3.png",deleteFlg:!1,status:"completed",currentRound:n,createdAt:new Date,updatedAt:new Date}],[t,n]);o.useEffect(()=>{if(t){console.log("📚 Storybook環境のためモック参加者ステータスを使用"),i(a()),d(!1);return}},[t,n,a]);const k=o.useCallback(async(b,h)=>b?(console.log("📚 Storybook環境のためステータス更新をモック"),f(!0),await new Promise(x=>setTimeout(x,500)),i(x=>x.map(u=>u.userId===b?{...u,status:h,currentRound:n}:u)),f(!1),!0):(c("ユーザーIDが不正です"),!1),[n]),w=o.useCallback(async b=>(console.log("📚 Storybook環境のため全ステータスリセットをモック"),f(!0),await new Promise(h=>setTimeout(h,1e3)),i(h=>h.map(x=>({...x,status:"thinking",currentRound:b}))),f(!1),!0),[t]),U=o.useCallback(()=>Ye(r,n),[r,n]),N=o.useCallback(b=>{const h=r.find(x=>x.userId===b);return(h==null?void 0:h.status)||"thinking"},[r]),C=o.useCallback(()=>{const b=r.filter(u=>u.status==="thinking").length,h=r.filter(u=>u.status==="entered").length,x=r.filter(u=>u.status==="completed").length;return{thinking:b,entered:h,completed:x,total:r.length}},[r]);return{participants:r,loading:l,error:m,updating:y,updateMyStatus:k,resetAllStatus:w,isRoundCompleted:U,getUserStatus:N,getStatusCounts:C}},et=()=>Me(Ee,"app","onlinedraft","selection"),tt=async(t,n,r,i,l="")=>{try{console.log("🔄 選択データ保存開始:",{userId:t,groupId:n,round:r,item:i});const d=Math.floor(Math.random()*1e6)+1,m={randomNumber:d,item:i,round:r,comment:l},c=Ue(et(),t);return(await Ne(c)).exists()?await we(c,{selection:Ie(m)}):await Ae(c,{userId:t,selection:[m],createdAt:new Date,updatedAt:new Date}),console.log("✅ 選択データ保存成功:",m),d.toString()}catch(d){throw console.error("❌ 選択データ保存エラー:",d),new Error("選択データの保存に失敗しました")}},q=({groupId:t,children:n})=>{const r=ae(),{isReady:i,needsUserSelection:l,hasAuthError:d,loading:m,authError:c,userError:y,currentUser:f,retry:a}=ce(t);return m?e.jsx(R,{maxW:"container.sm",py:{base:4,md:8},children:e.jsxs(p,{gap:6,align:"center",justify:"center",minH:"400px",children:[e.jsx(z,{size:"lg",color:"blue.500"}),e.jsxs(p,{gap:2,textAlign:"center",children:[e.jsx(D,{color:"gray.500",children:"認証中..."}),e.jsx(D,{fontSize:"sm",color:"gray.400",children:"Firebase認証とグループ情報を確認しています"})]})]})}):d?e.jsx(R,{maxW:"container.sm",py:{base:4,md:8},children:e.jsxs(p,{gap:6,align:"center",justify:"center",minH:"400px",children:[e.jsx(E,{fontSize:"48px",children:"🚫"}),e.jsxs(p,{gap:3,textAlign:"center",children:[e.jsx(D,{fontSize:"xl",fontWeight:"bold",color:"red.500",children:"アクセスできません"}),e.jsx(D,{color:"gray.500",children:c||"ドラフトグループが見つかりません"}),e.jsxs(p,{gap:2,pt:4,children:[e.jsx(I,{colorPalette:"blue",onClick:a,size:"md",children:"再試行"}),e.jsx(I,{variant:"ghost",onClick:()=>r.push("/"),size:"sm",children:"トップページに戻る"})]})]})]})}):l?(console.log("🔄 認証なしでDraftアクセス検出、ロビーページにリダイレクト:",{groupId:t}),r.replace(`/lobby/${t}`),e.jsx(R,{maxW:"container.sm",py:{base:4,md:8},children:e.jsxs(p,{gap:6,align:"center",justify:"center",minH:"400px",children:[e.jsx(z,{size:"lg",color:"blue.500"}),e.jsx(D,{color:"gray.500",children:"ロビーページに移動しています..."})]})})):y&&!l?e.jsx(R,{maxW:"container.sm",py:{base:4,md:8},children:e.jsxs(p,{gap:6,align:"center",justify:"center",minH:"400px",children:[e.jsx(E,{fontSize:"48px",children:"⚠️"}),e.jsxs(p,{gap:3,textAlign:"center",children:[e.jsx(D,{fontSize:"xl",fontWeight:"bold",color:"orange.500",children:"ユーザー情報エラー"}),e.jsx(D,{color:"gray.500",children:y}),e.jsxs(p,{gap:2,pt:4,children:[e.jsx(I,{colorPalette:"orange",onClick:a,size:"md",children:"再試行"}),e.jsx(I,{variant:"ghost",onClick:()=>r.push(`/lobby/${t}`),size:"sm",children:"ロビーページに移動"})]})]})]})}):i&&f?e.jsx(e.Fragment,{children:n}):e.jsx(R,{maxW:"container.sm",py:{base:4,md:8},children:e.jsxs(p,{gap:6,align:"center",justify:"center",minH:"400px",children:[e.jsx(E,{fontSize:"48px",children:"🤔"}),e.jsxs(p,{gap:3,textAlign:"center",children:[e.jsx(D,{fontSize:"xl",fontWeight:"bold",color:"gray.500",children:"予期しない状態です"}),e.jsxs(D,{color:"gray.400",fontSize:"sm",children:["認証状態:"," ",JSON.stringify({isReady:i,needsUserSelection:l,hasAuthError:d,hasCurrentUser:!!f})]}),e.jsxs(p,{gap:2,pt:4,children:[e.jsx(I,{colorPalette:"gray",onClick:a,size:"md",children:"再試行"}),e.jsx(I,{variant:"ghost",onClick:()=>r.push("/"),size:"sm",children:"トップページに戻る"})]})]})]})})};try{q.displayName="DraftAuthGuard",q.__docgenInfo={description:"",displayName:"DraftAuthGuard",props:{groupId:{defaultValue:null,description:"",name:"groupId",required:!0,type:{name:"string"}}}}}catch{}const st=({groupId:t,roundNumber:n,totalRounds:r,groupName:i,participants:l,currentUserSelection:d,onSubmitSelection:m,pastRounds:c,currentRoundTopic:y}={})=>{var X;const f=ie();ae();const a=t??(f==null?void 0:f.id),[k,w]=o.useState(""),[U,N]=o.useState(""),[C,b]=o.useState(""),[h,x]=o.useState(!1),[u,O]=o.useState({isOpen:!1,selectedRound:null,selectedUserId:null}),[T,B]=o.useState(!1),{currentUser:S}=ce(a),{groupData:j,groupLoading:_,groupError:L}=Oe(a),{groupUsers:H}=ve(a),A=n??(j==null?void 0:j.round)??1,{participants:ue,updateMyStatus:de}=Ze(a,A),{messages:V}=Qe(a,H),{sendMessage:pe}=Xe();console.log("📍 DraftPage - groupId:",a),console.log("📍 DraftPage - groupData:",j),console.log("📍 DraftPage - groupUsers:",H),console.log("📍 DraftPage - currentUser:",S),console.log("💬 DraftPage - messages:",V),o.useEffect(()=>{S&&j&&!_&&Pe({groupId:a,groupName:j.groupName||`ドラフト会議 ${a}`,lastJoined:Date.now()})},[S,j,_,a]),r??(j==null||j.round);const me=i??(j==null?void 0:j.groupName)??`ドラフト会議 ${a}`,v=l??H.map(s=>{const g=ue.find(F=>F.userId===s.userId);return{id:s.userId||"",name:s.userName,avatar:s.avatar,status:(g==null?void 0:g.status)||"thinking"}}),ge=d??k,W=c??le,fe=y??"好きなゲーム",he=m??(async(s,g)=>{if(!S||!a){console.error("❌ ユーザー情報またはグループIDが不正");return}try{console.log("🔄 選択データ保存開始:",{selection:s,comment:g}),await tt(S.id||"",a,A,s,g||""),console.log("✅ 選択データ保存成功"),w(s)}catch(F){console.error("❌ 選択データ保存エラー:",F),w(s)}}),xe=async()=>{U.trim()&&S&&(he(U.trim(),C.trim()||void 0),await de(S.id||"","entered")?(console.log("✅ 選択提出＆ステータス更新成功"),x(!1),N(""),b("")):console.error("❌ ステータス更新失敗（モーダルは開いたまま）"))},$=s=>{console.log("ラウンド全体クリック:",s)},J=(s,g)=>{O({isOpen:!0,selectedRound:s,selectedUserId:g})},Se=()=>{O({isOpen:!1,selectedRound:null,selectedUserId:null})},ye=(s,g)=>{console.log("ユーザー選択保存:",{roundNumber:s,selection:g})},K=()=>{N(ge),x(!0)},be=()=>{B(!0)},je=()=>{window.location.href="/"},De=()=>{console.log("設定画面を開く（今後実装）")},Ce=()=>{console.log("ヘルプ画面を開く（今後実装）")},Q=async s=>{if(!S||!a){console.error("❌ ユーザー情報またはグループIDが不正");return}await pe({groupId:a,userId:S.id||"",message:s})&&console.log("✅ メッセージ送信成功")};return _?e.jsx(R,{maxW:"container.sm",py:{base:4,md:8},children:e.jsxs(p,{gap:6,align:"center",justify:"center",minH:"400px",children:[e.jsx(z,{size:"lg",color:"blue.500"}),e.jsx(D,{color:"gray.500",children:"ドラフト情報を読み込み中..."})]})}):L||!j?e.jsx(R,{maxW:"container.sm",py:{base:4,md:8},children:e.jsxs(p,{gap:6,align:"center",justify:"center",minH:"400px",children:[e.jsx(E,{fontSize:"48px",children:"❌"}),e.jsxs(p,{gap:2,textAlign:"center",children:[e.jsx(D,{fontSize:"xl",fontWeight:"bold",color:"red.500",children:"ドラフト情報の取得に失敗"}),e.jsx(D,{color:"gray.500",children:L||"ドラフト情報を読み込めませんでした"})]})]})}):S?e.jsxs(R,{maxW:"1600px",p:{base:2,md:3,lg:4},minH:"100vh",position:"relative",_before:{content:'""',position:"absolute",top:0,left:0,right:0,bottom:0,bgGradient:"linear(to-br, purple.50, blue.50, pink.50)",opacity:.3,zIndex:-1,_dark:{bgGradient:"linear(to-br, purple.900/30, blue.900/30, pink.900/30)",opacity:.5}},children:[e.jsx(We,{groupName:me,onOpenOptions:be}),e.jsx(p,{gap:{base:3,md:4},align:"stretch",display:{base:"flex",lg:"none"},children:e.jsx(Fe,{roundNumber:A,participants:v,pastRounds:W,onRoundClick:$,onUserClick:J,onOpenInputModal:K,messages:V.map(s=>{var g;return{id:s.id,type:s.type==="system"?"system":"chat",timestamp:s.timestamp,content:s.message,user:s.type==="user"?{id:s.userId,name:s.userName,avatar:((g=s.user)==null?void 0:g.avatar)||"/img/1.png"}:void 0,isMyMessage:s.userId===(S==null?void 0:S.id)}}),onSendMessage:Q})}),e.jsxs($e,{templateColumns:"65fr 35fr",gap:8,minH:"70vh",display:{base:"none",lg:"grid"},children:[e.jsx(Z,{children:e.jsx(Be,{roundNumber:A,participants:v,pastRounds:W,onRoundClick:$,onUserClick:J,onOpenInputModal:K})}),e.jsx(Z,{children:e.jsx(Ve,{logs:V.map(s=>{var g;return{id:s.id,type:s.type==="system"?"system":"chat",timestamp:s.timestamp,content:s.message,user:s.type==="user"?{id:s.userId,name:s.userName,avatar:((g=s.user)==null?void 0:g.avatar)||"/img/1.png"}:void 0,isMyMessage:s.userId===(S==null?void 0:S.id)}}),onSendMessage:Q})})]}),e.jsx(qe,{isOpen:h,onClose:()=>x(!1),roundNumber:A,currentRoundTopic:fe,selection:U,comment:C,onSelectionChange:N,onCommentChange:b,onSubmit:xe}),u.selectedRound&&u.selectedUserId&&e.jsx(He,{isOpen:u.isOpen,onClose:Se,roundNumber:u.selectedRound,participant:v.find(s=>s.id===u.selectedUserId)||v[0],initialSelection:(X=W.find(s=>s.roundNumber===u.selectedRound))==null?void 0:X.selections.find(s=>s.userId===u.selectedUserId),onSaveSelection:ye}),e.jsx(Ge,{isOpen:T,onClose:()=>B(!1),onLeaveDraft:je,onOpenSettings:De,onOpenHelp:Ce})]}):e.jsx(R,{maxW:"container.sm",py:{base:4,md:8},children:e.jsxs(p,{gap:6,align:"center",justify:"center",minH:"400px",children:[e.jsx(z,{size:"lg",color:"blue.500"}),e.jsx(D,{color:"gray.500",children:"ユーザー情報を確認中..."})]})})},G=t=>{const n=ie(),r=t.groupId??(n==null?void 0:n.id);return r?e.jsx(q,{groupId:r,children:e.jsx(st,{...t})}):e.jsx(R,{maxW:"container.sm",py:{base:4,md:8},children:e.jsxs(p,{gap:6,align:"center",justify:"center",minH:"400px",children:[e.jsx(E,{fontSize:"48px",children:"⚠️"}),e.jsx(D,{fontSize:"xl",fontWeight:"bold",color:"orange.500",children:"グループIDが不正です"})]})})};try{G.displayName="DraftPage",G.__docgenInfo={description:`DraftPage - 認証ガード統合版
Firebase認証 + SessionUser管理による統合認証フローを提供`,displayName:"DraftPage",props:{groupId:{defaultValue:null,description:"",name:"groupId",required:!1,type:{name:"string"}},roundNumber:{defaultValue:null,description:"",name:"roundNumber",required:!1,type:{name:"number"}},totalRounds:{defaultValue:null,description:"",name:"totalRounds",required:!1,type:{name:"number"}},groupName:{defaultValue:null,description:"",name:"groupName",required:!1,type:{name:"string"}},participants:{defaultValue:null,description:"",name:"participants",required:!1,type:{name:'{ id: string; name: string; avatar: string; status: "thinking" | "entered" | "completed"; }[]'}},currentUserSelection:{defaultValue:null,description:"",name:"currentUserSelection",required:!1,type:{name:"string"}},onSubmitSelection:{defaultValue:null,description:"",name:"onSubmitSelection",required:!1,type:{name:"((selection: string, comment?: string) => void)"}},pastRounds:{defaultValue:null,description:"",name:"pastRounds",required:!1,type:{name:"{ roundNumber: number; topic: string; selections: { userId: string; userName: string; item: string; comment?: string; }[]; }[]"}},currentRoundTopic:{defaultValue:null,description:"",name:"currentRoundTopic",required:!1,type:{name:"string"}},logCount:{defaultValue:null,description:"",name:"logCount",required:!1,type:{name:"number"}},onUpdateSelections:{defaultValue:null,description:"",name:"onUpdateSelections",required:!1,type:{name:"((roundNumber: number, selections: { userId: string; userName: string; item: string; comment?: string; }[]) => void)"}}}}}catch{}const ss={title:"Features/Draft/DraftPage",component:G,parameters:{layout:"fullscreen"},decorators:[ze],tags:["autodocs"]},M={args:{roundNumber:3,totalRounds:5,groupName:"ドラフト会議 TEST",participants:Le,pastRounds:le,currentRoundTopic:"好きなゲーム",currentUserSelection:"ゼルダの伝説",onSubmitSelection:(t,n)=>{console.log("選択:",t,"コメント:",n)},onUpdateSelections:(t,n)=>{console.log("ラウンド",t,"の選択を更新:",n)}}},P={args:{...M.args,roundNumber:1,pastRounds:[],currentUserSelection:"",currentRoundTopic:"好きな食べ物"}};var ee,te,se;M.parameters={...M.parameters,docs:{...(ee=M.parameters)==null?void 0:ee.docs,source:{originalSource:`{
  args: {
    roundNumber: 3,
    totalRounds: 5,
    groupName: 'ドラフト会議 TEST',
    participants: mockParticipants,
    pastRounds: mockPastRounds,
    currentRoundTopic: '好きなゲーム',
    currentUserSelection: 'ゼルダの伝説',
    onSubmitSelection: (selection: string, comment?: string) => {
      console.log('選択:', selection, 'コメント:', comment);
    },
    onUpdateSelections: (roundNumber: number, selections) => {
      console.log('ラウンド', roundNumber, 'の選択を更新:', selections);
    }
  }
}`,...(se=(te=M.parameters)==null?void 0:te.docs)==null?void 0:se.source}}};var ne,re,oe;P.parameters={...P.parameters,docs:{...(ne=P.parameters)==null?void 0:ne.docs,source:{originalSource:`{
  args: {
    ...Default.args,
    roundNumber: 1,
    pastRounds: [],
    currentUserSelection: '',
    currentRoundTopic: '好きな食べ物'
  }
}`,...(oe=(re=P.parameters)==null?void 0:re.docs)==null?void 0:oe.source}}};const ns=["Default","Empty"];export{M as Default,P as Empty,ns as __namedExportsOrder,ss as default};
